<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Contacts Sync Manager</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { AlertCircle, Users, RefreshCw, CheckCircle, XCircle, ArrowLeftRight } = lucide;

        const GoogleContactsSync = () => {
          const [account1, setAccount1] = useState(null);
          const [account2, setAccount2] = useState(null);
          const [contacts1, setContacts1] = useState([]);
          const [contacts2, setContacts2] = useState([]);
          const [syncing, setSyncing] = useState(false);
          const [analysis, setAnalysis] = useState(null);
          const [view, setView] = useState('setup');
          const [selectedContacts, setSelectedContacts] = useState(new Set());
          const [activeTab, setActiveTab] = useState('sync');

          const CLIENT_ID = 'YOUR_GOOGLE_CLIENT_ID'; // Replace with your Client ID

          const handleGoogleLogin = (accountNumber) => {
            if (!window.google) {
              alert('Google API not loaded yet. Please wait a moment and try again.');
              return;
            }

            const client = window.google.accounts.oauth2.initTokenClient({
              client_id: CLIENT_ID,
              scope: 'https://www.googleapis.com/auth/contacts.readonly',
              callback: async (response) => {
                if (response.access_token) {
                  if (accountNumber === 1) {
                    setAccount1(response);
                    await fetchContacts(response.access_token, 1);
                  } else {
                    setAccount2(response);
                    await fetchContacts(response.access_token, 2);
                  }
                }
              },
            });
            
            client.requestAccessToken();
          };

          const fetchContacts = async (accessToken, accountNumber) => {
            try {
              const response = await fetch(
                'https://people.googleapis.com/v1/people/me/connections?personFields=names,emailAddresses,phoneNumbers&pageSize=1000',
                {
                  headers: {
                    Authorization: `Bearer ${accessToken}`,
                  },
                }
              );

              const data = await response.json();
              const formattedContacts = (data.connections || []).map(contact => ({
                id: contact.resourceName,
                name: contact.names?.[0]?.displayName || 'No Name',
                email: contact.emailAddresses?.[0]?.value || '',
                phone: contact.phoneNumbers?.[0]?.value || '',
                raw: contact,
              }));

              if (accountNumber === 1) {
                setContacts1(formattedContacts);
              } else {
                setContacts2(formattedContacts);
              }
            } catch (error) {
              console.error('Failed to fetch contacts:', error);
              alert('Failed to fetch contacts. Check console for details.');
            }
          };

          const analyzeContacts = () => {
            const inSync = [];
            const different = [];
            const onlyIn1 = [];
            const onlyIn2 = [];

            const contacts2Map = new Map(
              contacts2.map(c => [c.email.toLowerCase(), c])
            );

            contacts1.forEach(c1 => {
              if (!c1.email) {
                onlyIn1.push({ contact: c1, account: 1 });
                return;
              }

              const c2 = contacts2Map.get(c1.email.toLowerCase());
              if (!c2) {
                onlyIn1.push({ contact: c1, account: 1 });
              } else {
                contacts2Map.delete(c1.email.toLowerCase());
                if (c1.name === c2.name && c1.phone === c2.phone) {
                  inSync.push({ contact1: c1, contact2: c2 });
                } else {
                  different.push({ contact1: c1, contact2: c2 });
                }
              }
            });

            contacts2Map.forEach(c2 => {
              onlyIn2.push({ contact: c2, account: 2 });
            });

            setAnalysis({ inSync, different, onlyIn1, onlyIn2 });
            setView('results');
          };

          const syncSelected = async (direction) => {
            setSyncing(true);
            setTimeout(() => {
              alert(`Would sync ${selectedContacts.size} contacts from Account ${direction === 'to2' ? '1 to 2' : '2 to 1'}\n\nNote: Write functionality needs to be implemented with proper OAuth scopes.`);
              setSyncing(false);
              setSelectedContacts(new Set());
            }, 1000);
          };

          const toggleContactSelection = (id) => {
            const newSelected = new Set(selectedContacts);
            if (newSelected.has(id)) {
              newSelected.delete(id);
            } else {
              newSelected.add(id);
            }
            setSelectedContacts(newSelected);
          };

          const renderSetup = () => (
            <div className="max-w-4xl mx-auto p-6">
              <div className="bg-white rounded-lg shadow-lg p-8">
                <h1 className="text-3xl font-bold mb-6 text-gray-800">Google Contacts Sync Manager</h1>
                
                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                  <div className="flex items-start gap-3">
                    <AlertCircle className="text-yellow-600 mt-1" size={20} />
                    <div>
                      <h3 className="font-semibold text-yellow-800">Setup Required</h3>
                      <p className="text-sm text-yellow-700 mt-1">
                        To use this application, you need to:
                      </p>
                      <ol className="text-sm text-yellow-700 mt-2 list-decimal list-inside space-y-1">
                        <li>Create a project in Google Cloud Console</li>
                        <li>Enable the People API</li>
                        <li>Create OAuth 2.0 credentials</li>
                        <li>Replace YOUR_GOOGLE_CLIENT_ID in this file with your Client ID</li>
                        <li>Add this file's location to authorized JavaScript origins</li>
                      </ol>
                    </div>
                  </div>
                </div>

                <div className="grid md:grid-cols-2 gap-6">
                  <div className="border-2 border-gray-200 rounded-lg p-6">
                    <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
                      <Users size={24} className="text-blue-600" />
                      Account 1
                    </h2>
                    {account1 ? (
                      <div>
                        <div className="flex items-center gap-2 text-green-600 mb-4">
                          <CheckCircle size={20} />
                          <span className="font-medium">Connected</span>
                        </div>
                        <p className="text-sm text-gray-600">{contacts1.length} contacts found</p>
                      </div>
                    ) : (
                      <button
                        onClick={() => handleGoogleLogin(1)}
                        className="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition"
                      >
                        Connect Account 1
                      </button>
                    )}
                  </div>

                  <div className="border-2 border-gray-200 rounded-lg p-6">
                    <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
                      <Users size={24} className="text-purple-600" />
                      Account 2
                    </h2>
                    {account2 ? (
                      <div>
                        <div className="flex items-center gap-2 text-green-600 mb-4">
                          <CheckCircle size={20} />
                          <span className="font-medium">Connected</span>
                        </div>
                        <p className="text-sm text-gray-600">{contacts2.length} contacts found</p>
                      </div>
                    ) : (
                      <button
                        onClick={() => handleGoogleLogin(2)}
                        className="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition"
                      >
                        Connect Account 2
                      </button>
                    )}
                  </div>
                </div>

                {account1 && account2 && (
                  <div className="mt-8">
                    <button
                      onClick={analyzeContacts}
                      className="w-full bg-green-600 text-white py-3 px-6 rounded-lg hover:bg-green-700 transition font-semibold text-lg flex items-center justify-center gap-2"
                    >
                      <RefreshCw size={24} />
                      Analyze Contacts
                    </button>
                  </div>
                )}
              </div>
            </div>
          );

          const renderContactCard = (contact, selectable, id) => (
            <div
              key={id}
              className={`border rounded-lg p-4 ${selectable ? 'cursor-pointer hover:bg-gray-50' : ''} ${
                selectedContacts.has(id) ? 'bg-blue-50 border-blue-300' : 'bg-white'
              }`}
              onClick={() => selectable && toggleContactSelection(id)}
            >
              <div className="flex items-start justify-between">
                <div>
                  <h3 className="font-semibold text-gray-800">{contact.name}</h3>
                  <p className="text-sm text-gray-600 mt-1">{contact.email}</p>
                  {contact.phone && <p className="text-sm text-gray-600">{contact.phone}</p>}
                </div>
                {selectable && (
                  <input
                    type="checkbox"
                    checked={selectedContacts.has(id)}
                    onChange={() => {}}
                    className="mt-1"
                  />
                )}
              </div>
            </div>
          );

          const renderResults = () => {
            if (!analysis) return null;

            const tabs = [
              { id: 'sync', label: 'In Sync', count: analysis.inSync.length, color: 'green' },
              { id: 'diff', label: 'Different', count: analysis.different.length, color: 'yellow' },
              { id: 'only1', label: 'Only in Account 1', count: analysis.onlyIn1.length, color: 'blue' },
              { id: 'only2', label: 'Only in Account 2', count: analysis.onlyIn2.length, color: 'purple' },
            ];

            return (
              <div className="max-w-6xl mx-auto p-6">
                <div className="bg-white rounded-lg shadow-lg p-8">
                  <div className="flex justify-between items-center mb-6">
                    <h1 className="text-3xl font-bold text-gray-800">Sync Analysis</h1>
                    <button
                      onClick={() => setView('setup')}
                      className="text-blue-600 hover:text-blue-700 font-medium"
                    >
                      ← Back to Setup
                    </button>
                  </div>

                  <div className="flex gap-2 mb-6 overflow-x-auto">
                    {tabs.map(tab => (
                      <button
                        key={tab.id}
                        onClick={() => setActiveTab(tab.id)}
                        className={`px-4 py-2 rounded-lg font-medium whitespace-nowrap ${
                          activeTab === tab.id
                            ? 'bg-' + tab.color + '-600 text-white'
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                        }`}
                        style={activeTab === tab.id ? {
                          backgroundColor: tab.color === 'green' ? '#16a34a' : 
                                         tab.color === 'yellow' ? '#ca8a04' :
                                         tab.color === 'blue' ? '#2563eb' : '#9333ea'
                        } : {}}
                      >
                        {tab.label} ({tab.count})
                      </button>
                    ))}
                  </div>

                  <div className="space-y-4">
                    {activeTab === 'sync' && (
                      <div>
                        <p className="text-gray-600 mb-4">These contacts are identical in both accounts.</p>
                        <div className="grid gap-4">
                          {analysis.inSync.map((item, idx) => (
                            <div key={idx} className="border rounded-lg p-4 bg-green-50">
                              <div className="flex items-center justify-between">
                                <div>
                                  <h3 className="font-semibold text-gray-800">{item.contact1.name}</h3>
                                  <p className="text-sm text-gray-600">{item.contact1.email}</p>
                                  {item.contact1.phone && <p className="text-sm text-gray-600">{item.contact1.phone}</p>}
                                </div>
                                <CheckCircle className="text-green-600" size={24} />
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {activeTab === 'diff' && (
                      <div>
                        <p className="text-gray-600 mb-4">These contacts exist in both accounts but have different information.</p>
                        <div className="grid gap-4">
                          {analysis.different.map((item, idx) => (
                            <div key={idx} className="border rounded-lg p-4 bg-yellow-50">
                              <div className="grid md:grid-cols-2 gap-4">
                                <div>
                                  <p className="text-xs font-semibold text-blue-600 mb-2">ACCOUNT 1</p>
                                  <h3 className="font-semibold text-gray-800">{item.contact1.name}</h3>
                                  <p className="text-sm text-gray-600">{item.contact1.email}</p>
                                  {item.contact1.phone && <p className="text-sm text-gray-600">{item.contact1.phone}</p>}
                                </div>
                                <div>
                                  <p className="text-xs font-semibold text-purple-600 mb-2">ACCOUNT 2</p>
                                  <h3 className="font-semibold text-gray-800">{item.contact2.name}</h3>
                                  <p className="text-sm text-gray-600">{item.contact2.email}</p>
                                  {item.contact2.phone && <p className="text-sm text-gray-600">{item.contact2.phone}</p>}
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {activeTab === 'only1' && (
                      <div>
                        <p className="text-gray-600 mb-4">These contacts only exist in Account 1.</p>
                        {selectedContacts.size > 0 && (
                          <button
                            onClick={() => syncSelected('to2')}
                            disabled={syncing}
                            className="mb-4 bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition flex items-center gap-2"
                          >
                            <ArrowLeftRight size={20} />
                            Copy {selectedContacts.size} to Account 2
                          </button>
                        )}
                        <div className="grid gap-4">
                          {analysis.onlyIn1.map((item, idx) => 
                            renderContactCard(item.contact, true, `only1-${idx}`)
                          )}
                        </div>
                      </div>
                    )}

                    {activeTab === 'only2' && (
                      <div>
                        <p className="text-gray-600 mb-4">These contacts only exist in Account 2.</p>
                        {selectedContacts.size > 0 && (
                          <button
                            onClick={() => syncSelected('to1')}
                            disabled={syncing}
                            className="mb-4 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition flex items-center gap-2"
                          >
                            <ArrowLeftRight size={20} />
                            Copy {selectedContacts.size} to Account 1
                          </button>
                        )}
                        <div className="grid gap-4">
                          {analysis.onlyIn2.map((item, idx) => 
                            renderContactCard(item.contact, true, `only2-${idx}`)
                          )}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            );
          };

          return (
            <div className="min-h-screen bg-gray-100">
              {view === 'setup' ? renderSetup() : renderResults()}
            </div>
          );
        };

        ReactDOM.render(<GoogleContactsSync />, document.getElementById('root'));
    </script>
</body>
</html>
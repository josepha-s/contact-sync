<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Contacts Sync Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .card { background: white; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .contact-card { border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 0.5rem; }
        .contact-card.selectable { cursor: pointer; }
        .contact-card.selected { background: #eff6ff; border-color: #93c5fd; }
        .tab { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; cursor: pointer; background: #f3f4f6; color: #374151; white-space: nowrap; }
        .tab.active { background: #3b82f6; color: white; }
        .tab:hover:not(.active) { background: #e5e7eb; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app"></div>

    <script>
        const CLIENT_ID = '831265054099-6jt17bkg2huo43olkg01t3vpk58kg06h.apps.googleusercontent.com'; // Replace with your actual Client ID
        
        let state = {
            account1: null,
            account2: null,
            contacts1: [],
            contacts2: [],
            view: 'setup',
            analysis: null,
            activeTab: 'sync',
            selectedContacts: new Set(),
            error: null
        };

        function setState(newState) {
            state = { ...state, ...newState };
            render();
        }

        function icon(type, size = 24) {
            const icons = {
                alert: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`,
                users: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
                refresh: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>`,
                check: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>`,
                arrow: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>`
            };
            return icons[type] || '';
        }

        async function handleGoogleLogin(accountNumber) {
            if (!window.google) {
                setState({ error: 'Google API not loaded. Please refresh and try again.' });
                return;
            }

            if (CLIENT_ID === '831265054099-6jt17bkg2huo43olkg01t3vpk58kg06h.apps.googleusercontent.com') {
                setState({ error: 'Test: Please replace YOUR_GOOGLE_CLIENT_ID with your actual Google OAuth Client ID in the HTML file.' });
                return;
            }

            try {
                const client = window.google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/contacts.readonly',
                    callback: async (response) => {
                        if (response.access_token) {
                            setState({ error: null });
                            if (accountNumber === 1) {
                                setState({ account1: response });
                                await fetchContacts(response.access_token, 1);
                            } else {
                                setState({ account2: response });
                                await fetchContacts(response.access_token, 2);
                            }
                        }
                    }
                });
                client.requestAccessToken();
            } catch (err) {
                setState({ error: `Login error: ${err.message}` });
            }
        }

        async function fetchContacts(accessToken, accountNumber) {
            try {
                const response = await fetch(
                    'https://people.googleapis.com/v1/people/me/connections?personFields=names,emailAddresses,phoneNumbers&pageSize=1000',
                    { headers: { Authorization: `Bearer ${accessToken}` } }
                );

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                const contacts = (data.connections || []).map(c => ({
                    id: c.resourceName,
                    name: c.names?.[0]?.displayName || 'No Name',
                    email: c.emailAddresses?.[0]?.value || '',
                    phone: c.phoneNumbers?.[0]?.value || ''
                }));

                if (accountNumber === 1) {
                    setState({ contacts1: contacts });
                } else {
                    setState({ contacts2: contacts });
                }
            } catch (error) {
                setState({ error: `Failed to fetch contacts: ${error.message}` });
            }
        }

        function analyzeContacts() {
            const inSync = [], different = [], onlyIn1 = [], onlyIn2 = [];
            const map2 = new Map(state.contacts2.map(c => [c.email.toLowerCase(), c]));

            state.contacts1.forEach(c1 => {
                if (!c1.email) {
                    onlyIn1.push({ contact: c1 });
                    return;
                }
                const c2 = map2.get(c1.email.toLowerCase());
                if (!c2) {
                    onlyIn1.push({ contact: c1 });
                } else {
                    map2.delete(c1.email.toLowerCase());
                    if (c1.name === c2.name && c1.phone === c2.phone) {
                        inSync.push({ contact1: c1, contact2: c2 });
                    } else {
                        different.push({ contact1: c1, contact2: c2 });
                    }
                }
            });

            map2.forEach(c2 => onlyIn2.push({ contact: c2 }));

            setState({ 
                analysis: { inSync, different, onlyIn1, onlyIn2 },
                view: 'results',
                activeTab: 'sync',
                selectedContacts: new Set()
            });
        }

        function toggleContact(id) {
            const selected = new Set(state.selectedContacts);
            if (selected.has(id)) selected.delete(id);
            else selected.add(id);
            setState({ selectedContacts: selected });
        }

        function syncSelected(direction) {
            alert(`Would sync ${state.selectedContacts.size} contacts ${direction === 'to2' ? 'from Account 1 to 2' : 'from Account 2 to 1'}\n\nNote: Actual sync requires write permissions.`);
            setState({ selectedContacts: new Set() });
        }

        function renderSetup() {
            return `
                <div class="max-w-4xl mx-auto p-6">
                    <div class="card">
                        <h1 class="text-3xl font-bold mb-6">Google Contacts Sync Manager</h1>
                        
                        ${state.error ? `
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                                <div class="flex items-start gap-3">
                                    <span class="text-red-600">${icon('alert', 20)}</span>
                                    <div>
                                        <h3 class="font-semibold text-red-800">Error</h3>
                                        <p class="text-sm text-red-700 mt-1">${state.error}</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                            <div class="flex items-start gap-3">
                                <span class="text-yellow-600">${icon('alert', 20)}</span>
                                <div class="text-sm text-yellow-700">
                                    <h3 class="font-semibold text-yellow-800 mb-2">Setup Required</h3>
                                    <ol class="list-decimal list-inside space-y-1">
                                        <li>Create a project in <a href="https://console.cloud.google.com" target="_blank" class="underline">Google Cloud Console</a></li>
                                        <li>Enable the People API</li>
                                        <li>Create OAuth 2.0 credentials (Web application)</li>
                                        <li>Add your domain to authorized JavaScript origins</li>
                                        <li>Replace YOUR_GOOGLE_CLIENT_ID in this HTML file</li>
                                    </ol>
                                </div>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            <div class="border-2 border-gray-200 rounded-lg p-6">
                                <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                                    <span class="text-blue-600">${icon('users')}</span>
                                    Account 1
                                </h2>
                                ${state.account1 ? `
                                    <div class="flex items-center gap-2 text-green-600 mb-2">
                                        ${icon('check', 20)}
                                        <span class="font-medium">Connected</span>
                                    </div>
                                    <p class="text-sm text-gray-600">${state.contacts1.length} contacts</p>
                                ` : `
                                    <button onclick="handleGoogleLogin(1)" class="btn w-full bg-blue-600 text-white hover:bg-blue-700">
                                        Connect Account 1
                                    </button>
                                `}
                            </div>

                            <div class="border-2 border-gray-200 rounded-lg p-6">
                                <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                                    <span class="text-purple-600">${icon('users')}</span>
                                    Account 2
                                </h2>
                                ${state.account2 ? `
                                    <div class="flex items-center gap-2 text-green-600 mb-2">
                                        ${icon('check', 20)}
                                        <span class="font-medium">Connected</span>
                                    </div>
                                    <p class="text-sm text-gray-600">${state.contacts2.length} contacts</p>
                                ` : `
                                    <button onclick="handleGoogleLogin(2)" class="btn w-full bg-purple-600 text-white hover:bg-purple-700">
                                        Connect Account 2
                                    </button>
                                `}
                            </div>
                        </div>

                        ${state.account1 && state.account2 ? `
                            <button onclick="analyzeContacts()" class="btn w-full bg-green-600 text-white hover:bg-green-700 py-3 text-lg flex items-center justify-center gap-2">
                                <span>${icon('refresh')}</span>
                                Analyze Contacts
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderResults() {
            const { inSync, different, onlyIn1, onlyIn2 } = state.analysis;
            const tabs = [
                { id: 'sync', label: 'In Sync', count: inSync.length },
                { id: 'diff', label: 'Different', count: different.length },
                { id: 'only1', label: 'Only in Account 1', count: onlyIn1.length },
                { id: 'only2', label: 'Only in Account 2', count: onlyIn2.length }
            ];

            let content = '';
            
            if (state.activeTab === 'sync') {
                content = inSync.map(item => `
                    <div class="contact-card bg-green-50">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-semibold">${item.contact1.name}</h3>
                                <p class="text-sm text-gray-600">${item.contact1.email}</p>
                                ${item.contact1.phone ? `<p class="text-sm text-gray-600">${item.contact1.phone}</p>` : ''}
                            </div>
                            <span class="text-green-600">${icon('check')}</span>
                        </div>
                    </div>
                `).join('') || '<p class="text-gray-500 italic">No contacts in sync</p>';
            } else if (state.activeTab === 'diff') {
                content = different.map(item => `
                    <div class="contact-card bg-yellow-50">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs font-semibold text-blue-600 mb-1">ACCOUNT 1</p>
                                <h3 class="font-semibold">${item.contact1.name}</h3>
                                <p class="text-sm text-gray-600">${item.contact1.email}</p>
                                ${item.contact1.phone ? `<p class="text-sm text-gray-600">${item.contact1.phone}</p>` : ''}
                            </div>
                            <div>
                                <p class="text-xs font-semibold text-purple-600 mb-1">ACCOUNT 2</p>
                                <h3 class="font-semibold">${item.contact2.name}</h3>
                                <p class="text-sm text-gray-600">${item.contact2.email}</p>
                                ${item.contact2.phone ? `<p class="text-sm text-gray-600">${item.contact2.phone}</p>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('') || '<p class="text-gray-500 italic">No differing contacts</p>';
            } else if (state.activeTab === 'only1') {
                const header = state.selectedContacts.size > 0 ? `
                    <button onclick="syncSelected('to2')" class="btn bg-purple-600 text-white hover:bg-purple-700 mb-4">
                        Copy ${state.selectedContacts.size} to Account 2
                    </button>
                ` : '';
                content = header + (onlyIn1.map((item, i) => {
                    const id = `only1-${i}`;
                    return `
                        <div class="contact-card selectable ${state.selectedContacts.has(id) ? 'selected' : ''}" onclick="toggleContact('${id}')">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <h3 class="font-semibold">${item.contact.name}</h3>
                                    <p class="text-sm text-gray-600">${item.contact.email}</p>
                                    ${item.contact.phone ? `<p class="text-sm text-gray-600">${item.contact.phone}</p>` : ''}
                                </div>
                                <input type="checkbox" ${state.selectedContacts.has(id) ? 'checked' : ''} onclick="event.stopPropagation()">
                            </div>
                        </div>
                    `;
                }).join('') || '<p class="text-gray-500 italic">No contacts only in Account 1</p>');
            } else {
                const header = state.selectedContacts.size > 0 ? `
                    <button onclick="syncSelected('to1')" class="btn bg-blue-600 text-white hover:bg-blue-700 mb-4">
                        Copy ${state.selectedContacts.size} to Account 1
                    </button>
                ` : '';
                content = header + (onlyIn2.map((item, i) => {
                    const id = `only2-${i}`;
                    return `
                        <div class="contact-card selectable ${state.selectedContacts.has(id) ? 'selected' : ''}" onclick="toggleContact('${id}')">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <h3 class="font-semibold">${item.contact.name}</h3>
                                    <p class="text-sm text-gray-600">${item.contact.email}</p>
                                    ${item.contact.phone ? `<p class="text-sm text-gray-600">${item.contact.phone}</p>` : ''}
                                </div>
                                <input type="checkbox" ${state.selectedContacts.has(id) ? 'checked' : ''} onclick="event.stopPropagation()">
                            </div>
                        </div>
                    `;
                }).join('') || '<p class="text-gray-500 italic">No contacts only in Account 2</p>');
            }

            return `
                <div class="max-w-6xl mx-auto p-6">
                    <div class="card">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-3xl font-bold">Sync Analysis</h1>
                            <button onclick="setState({ view: 'setup', selectedContacts: new Set() })" class="text-blue-600 hover:text-blue-700 font-medium">
                                ← Back to Setup
                            </button>
                        </div>

                        <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
                            ${tabs.map(tab => `
                                <button onclick="setState({ activeTab: '${tab.id}', selectedContacts: new Set() })" 
                                        class="tab ${state.activeTab === tab.id ? 'active' : ''}">
                                    ${tab.label} (${tab.count})
                                </button>
                            `).join('')}
                        </div>

                        <div class="max-h-96 overflow-y-auto">
                            ${content}
                        </div>
                    </div>
                </div>
            `;
        }

        function render() {
            const html = state.view === 'setup' ? renderSetup() : renderResults();
            document.getElementById('app').innerHTML = html;
        }

        // Load Google API
        const script = document.createElement('script');
        script.src = 'https://accounts.google.com/gsi/client';
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);

        // Initial render
        render();
    </script>
</body>
</html>
